<html>

<head>
    <style>
  .img-overlay-wrap {
        position: relative;
        display: inline-block; /* <= shrinks container to image size */
        transition: transform 150ms ease-in-out;
        margin: 50px 50px;
      }
      
      .img-overlay-wrap img { /* <= optional, for responsiveness */
         display: block;
         max-width: 100%;
         height: auto;
      }
      
      .img-overlay-wrap svg {
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
</head>

<body>
    <div id="container" class="img-overlay-wrap"></div>

    <script>

        class Draggable {

            constructor() {
                this._onDrag = () => {}
            }

            _onMouseDown = e => {
                this.dragging=true;
                this.prevMouseEvent = e;
            }

            _onMouseUp = e => {
                this.dragging = false;
            }

            _onMouseMove = e => {
                if(!this.dragging) return;
                const displayDeltaX = e.x - this.prevMouseEvent.x;
                const displayDeltaY = e.y - this.prevMouseEvent.y;
                this._onDrag(displayDeltaX, displayDeltaY);
                this.prevMouseEvent = e;
            }

            _onMouseLeave = e => {
                //console.log("mouseLeave");
            }

            _setDragCallbacks = htmlNode => {
                htmlNode.onmousedown = this._onMouseDown;
                htmlNode.onmouseup = this._onMouseUp;
                htmlNode.onmouseleave = this._onMouseUp;
                htmlNode.onmousemove = this._onMouseMove;
            }
        }

        class ResizeDot extends Draggable {
            constructor(actualX, actualY, actualRadius) {
                super();
                this.actualX = actualX;
                this.actualY = actualY;
                this.actualRadius = actualRadius;
                this.htmlNode = this._createHtmlNode();
            }

            getHtmlNode = () => this.htmlNode;

            updateDisplayRatio = (ratio) => {
                const displayX = this.actualX * ratio;
                const displayY = this.actualY * ratio;
                const displayRadius = this.actualRadius * ratio;
                this.htmlNode.setAttributeNS(null, 'cx', displayX);
                this.htmlNode.setAttributeNS(null, 'cy',  displayY);
                this.htmlNode.setAttributeNS(null,'r', displayRadius);
            }

            moveByDisplayDelta = (displayDeltaX, displayDeltaY, ratio) => {
                const actualDeltaX = displayDeltaX / ratio;
                const actualDeltaY = displayDeltaY / ratio;
                this.actualX += actualDeltaX;
                this.actualY += actualDeltaY;
                const displayX = this.actualX * ratio;
                const displayY = this.actualY * ratio;
                this.htmlNode.setAttributeNS(null, 'cx', displayX);
                this.htmlNode.setAttributeNS(null, 'cy',  displayY);
            }

            _createHtmlNode = () => {
                const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                dot.setAttribute('style', "fill:blue;");
                this._setDragCallbacks(dot);
                return dot;
            }
        }

        class SelectionRectangle extends Draggable {
            constructor(actualX, actualY, actualWidth, actualHeight) {
                super();
                this.actualX = actualX;
                this.actualY = actualY;
                this.actualWidth = actualWidth;
                this.actualHeight = actualHeight;
                this.htmlNode = this._createHtmlNode();
                this.onDrag = null;
            }

            getHtmlNode = () => this.htmlNode;

            updateDisplayRatio = (ratio) =>{
                const displayX = this.actualX * ratio;
                const displayY = this.actualY * ratio;
                const displayWidth = this.actualWidth * ratio;
                const displayHeight = this.actualHeight * ratio;
                this.htmlNode.setAttributeNS(null, 'x', displayX);
                this.htmlNode.setAttributeNS(null, 'y',  displayY);
                this.htmlNode.setAttributeNS(null, 'width', displayWidth);
                this.htmlNode.setAttributeNS(null, 'height', displayHeight);
            }

            moveByDisplayDelta = (displayDeltaX, displayDeltaY, ratio) => {
                const actualDeltaX = displayDeltaX / ratio;
                const actualDeltaY = displayDeltaY / ratio;
                this.actualX += actualDeltaX;
                this.actualY += actualDeltaY;
                const displayX = this.actualX * ratio;
                const displayY = this.actualY * ratio;
                this.htmlNode.setAttributeNS(null, 'x', displayX);
                this.htmlNode.setAttributeNS(null, 'y',  displayY);
            }

            resizeByDisplayDelta = (displayDeltaWidth, displayDeltaHeight, ratio) => {
                const actualDeltaWidth = displayDeltaWidth / ratio;
                const actualDeltaHeight = displayDeltaHeight / ratio;
                this.actualWidth += actualDeltaWidth;
                this.actualHeight += actualDeltaHeight;
                const displayWidth = this.actualWidth * ratio;
                const displayHeight = this.actualHeight * ratio;
                this.htmlNode.setAttributeNS(null, 'width', displayWidth);
                this.htmlNode.setAttributeNS(null, 'height',  displayHeight);
            }

            _createHtmlNode = () => {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute('style', "fill:blue;stroke:pink;stroke-width:1;fill-opacity:0.5;stroke-opacity:1");
                this._setDragCallbacks(rect);
                return rect;
            }
        }

        class Selection {

            constructor(actualX, actualY, actualWidth, actualHeight) {
                this.actualX = actualX;
                this.actualY = actualY;
                this.actualWidth = actualWidth;
                this.actualHeight = actualHeight;
                this.htmlNode = this._createHtmlNode();
                this.ratio = 1;
            }

            getHtmlNode = () => this.htmlNode;

            updateDisplayRatio = (ratio) => {
                this.ratio = ratio;
                [this.selectionRectangle, ...this.resizeDots].forEach(childElement => childElement.updateDisplayRatio(ratio));
            }

            moveSelectionByDisplayDelta = (displayDeltaX, displayDeltaY) => {
                [this.selectionRectangle, ...this.resizeDots].forEach(childElement => 
                    childElement.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio));
            }

            _createHtmlNode = () => {
                const selectionGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                this.selectionRectangle = new SelectionRectangle(this.actualX, this.actualY, this.actualWidth, this.actualHeight);
                this.selectionRectangle._onDrag = this.moveSelectionByDisplayDelta;
                this.resizeDots = this._createResizeDots();
                selectionGroup.appendChild(this.selectionRectangle.getHtmlNode());
                this.resizeDots.forEach(resizeDot => selectionGroup.appendChild(resizeDot.getHtmlNode()));
                return selectionGroup;
            }

            _onBottomRightResizeDotMove = (displayDeltaX, displayDeltaY) => {
                this.bottomRight.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
                this.bottomLeft.moveByDisplayDelta(0, displayDeltaY, this.ratio);
                this.topRight.moveByDisplayDelta(displayDeltaX, 0, this.ratio);
                this.selectionRectangle.resizeByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
            }

            _onTopLeftResizeDotMove = (displayDeltaX, displayDeltaY) => {
                this.topLeft.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
                this.topRight.moveByDisplayDelta(0, displayDeltaY, this.ratio);
                this.bottomLeft.moveByDisplayDelta(displayDeltaX, 0, this.ratio);
                this.selectionRectangle.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
                this.selectionRectangle.resizeByDisplayDelta(-displayDeltaX, -displayDeltaY, this.ratio);
            }

            _onTopRightResizeDotMove = (displayDeltaX, displayDeltaY) => {
                this.topRight.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
                this.topLeft.moveByDisplayDelta(0, displayDeltaY, this.ratio);
                this.bottomRight.moveByDisplayDelta(displayDeltaX, 0, this.ratio);
                this.selectionRectangle.moveByDisplayDelta(0, displayDeltaY, this.ratio);
                this.selectionRectangle.resizeByDisplayDelta(displayDeltaX, -displayDeltaY, this.ratio);
            }

            _onBottomLeftResizeDotMove = (displayDeltaX, displayDeltaY) => {
                this.bottomLeft.moveByDisplayDelta(displayDeltaX, displayDeltaY, this.ratio);
                this.bottomRight.moveByDisplayDelta(0, displayDeltaY, this.ratio);
                this.topLeft.moveByDisplayDelta(displayDeltaX, 0, this.ratio);
                this.selectionRectangle.moveByDisplayDelta(displayDeltaX, 0, this.ratio);
                this.selectionRectangle.resizeByDisplayDelta(-displayDeltaX, displayDeltaY, this.ratio);
            }

            _createResizeDots = () => {
                const dotSize = 20;
                this.topLeft = new ResizeDot(this.actualX, this.actualY, dotSize);
                this.topRight = new ResizeDot(this.actualX + this.actualWidth, this.actualY, dotSize);
                this.bottomRight = new ResizeDot(this.actualX + this.actualWidth, this.actualY + this.actualHeight, dotSize);
                this.bottomLeft = new ResizeDot(this.actualX, this.actualY + this.actualHeight, dotSize);
                this.bottomRight._onDrag = this._onBottomRightResizeDotMove;
                this.topLeft._onDrag = this._onTopLeftResizeDotMove;
                this.topRight._onDrag = this._onTopRightResizeDotMove;
                this.bottomLeft._onDrag = this._onBottomLeftResizeDotMove;
                return [this.topLeft, this.topRight, this.bottomRight, this.bottomLeft];
            }
        }


        class ImageContainer {

            constructor(url){
                this.url = url;
                this.selections = [];
                this.container = document.getElementById("container");
                this.img = null;
                this.svgCanvas = null;
            }

            render = () => {
                this._renderImage();
                this._renderSvgCanvas();
                this.renderSelections(); //will be removed as by default the selections arent visible
            }

            renderSelections = () => {
                this.selections.forEach(this._renderSingleSelection);
            }

            clearSelections = () => {
                this.svgCanvas.innerHTML = '';
            }

            _addSelection = (displayX, displayY) => {
                const actualX = displayX / this.ratio;
                const actualY = displayY / this.ratio;
                const actualWidth = 400.0;
                const actualHeight = 400.0;
                const selection = new Selection(actualX, actualY, actualWidth, actualHeight);
                this.selections.push(selection);
                this._renderSingleSelection(selection);
            }

            _resizeSelectionsByRatio = (ratio) => {
                this.selections.forEach(selection => selection.updateDisplayRatio(ratio));
            }

            _renderSingleSelection = (selection) => {
                selection.updateDisplayRatio(this.ratio);
                this.svgCanvas.appendChild(selection.getHtmlNode());
            } 

            _onWindowResize = e => {
                this.ratio = this.img.width / this.width;
                this._resizeSelectionsByRatio(this.ratio);
            }

            _onImageLoad = () => {
                this.width = this.img.naturalWidth;
                this.height = this.img.naturalHeight;
                this.ratio = this.img.width / this.width; 
            }

            _renderImage = () => {
                const img = document.createElement('img');
                img.onload = this._onImageLoad;                 
                img.src = this.url
                this.container.appendChild(img);
                this.img = img;
                window.onresize = this._onWindowResize
            }

            _renderSvgCanvas = () => {
                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                svg.setAttribute('style', 'border: 1px solid black');
                svg.setAttribute('width', '100%');
                svg.setAttribute('height', '100%');
                svg.setAttributeNS("http://www.w3.org/2000/xmlns/", "xmlns:xlink", "http://www.w3.org/1999/xlink");
                svg.oncontextmenu = (e) => {
                    this._addSelection(e.layerX, e.layerY)
                }
                this.svgCanvas = svg;
                this.container.appendChild(svg);
            }
        }



        var urls = ["https://akcios-ujsag.hu/wp-content/uploads/2021/02/aldi-akcios-ujsag-20210204-0210_Page_01.jpg"];

        urls.forEach(url => {
            const loader = new ImageContainer(url);
            loader.render();
        })


    </script>
  


    

    

</body>

</html>